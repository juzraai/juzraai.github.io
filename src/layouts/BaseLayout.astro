---
import type { BlogPosting, WebSite, WithContext } from 'schema-dts';
import BlogButton from '../components/BlogButton.astro';
import DarkModeToggle from '../components/DarkModeToggle.astro';
import LangSwitcher from '../components/LangSwitcher.astro';
import { locales, type AltLinks, type Lang } from '../content/config';

const SITE_TITLE = 'Zsolt JurÃ¡nyi (juzraai)';

type Props = {
	alt: AltLinks;
	date?: Date;
	description?: string;
	image?: string;
	lang: Lang;
	title?: string;
};
const { alt, date, description, image, lang, title } = Astro.props;

const blogURL = new URL('/blog/', Astro.site).toString();
const canonicalURL = new URL(Astro.url.pathname, Astro.site).toString();

const altLinks = Object.entries(alt ?? {}).map(([lang, path]) => ({
	hreflang: lang,
	href: new URL(path, Astro.site).toString(),
}));

const fullTitle = title ? `${title} | ${SITE_TITLE}` : SITE_TITLE;

const locale = locales[lang];

let fullImage = image;
if (image && !image?.startsWith('http')) fullImage = new URL(image, Astro.site).toString();

const isPost = /blog\/\d{4}/.exec(Astro.url.pathname);
const type = isPost ? 'article' : 'website';

const websiteSchema: WithContext<WebSite> = {
	'@context': 'https://schema.org',
	'@type': 'WebSite',
	description,
	image: fullImage,
	name: fullTitle,
	headline: title,
	url: canonicalURL,
};
const blogPostSchema: WithContext<BlogPosting> = {
	'@context': 'https://schema.org',
	'@type': 'BlogPosting',
	description,
	dateCreated: date?.toISOString(),
	datePublished: date?.toISOString(),
	headline: title,
	image,
	mainEntityOfPage: {
		'@type': 'WebSite',
		url: blogURL,
	},
	name: title,
	url: canonicalURL,
};
const schema = isPost ? blogPostSchema : websiteSchema;

// TODO google analytics + cookie consent
---

<html lang={lang}>
	<head>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width"
		/>
		<meta
			name="generator"
			content={Astro.generator}
		/>
		<link
			rel="icon"
			type="image/svg+xml"
			href="/favicon.svg"
		/>
		<link
			rel="sitemap"
			href="/sitemap-index.xml"
		/>
		<link
			rel="canonical"
			href={canonicalURL}
		/>
		{
			altLinks.map(({ hreflang, href }) => (
				<link
					rel="alternate"
					hreflang={hreflang}
					href={href}
				/>
			))
		}
		<title>{fullTitle}</title>
		<meta
			name="description"
			content={description}
		/>
		<meta
			property="og:description"
			content={description}
		/>
		{
			image && (
				<meta
					property="og:image"
					content={fullImage}
				/>
			)
		}
		<meta
			property="og:locale"
			content={locale}
		/>
		<meta
			property="og:site_name"
			content={SITE_TITLE}
		/>
		<meta
			property="og:title"
			content={title}
		/>
		<meta
			property="og:type"
			content={type}
		/>
		<meta
			property="og:url"
			content={canonicalURL}
		/>
		<script
			type="application/ld+json"
			set:html={JSON.stringify(schema)}
		/>
	</head>
	<body>
		<BlogButton lang={lang} />
		<LangSwitcher
			alt={alt}
			current={lang}
		/>
		<DarkModeToggle />
		<slot />
	</body>
</html>
